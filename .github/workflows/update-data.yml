name: Update Market Data

on:
  schedule:
    # Run at 9 AM EST weekdays only (before market open)
    - cron: '0 14 * * 1-5'   # 14:00 UTC = 9:00 AM EST (Mon-Fri)
    # Run at 5 PM EST weekdays only (after market close)  
    - cron: '0 22 * * 1-5'   # 22:00 UTC = 5:00 PM EST (Mon-Fri)
  workflow_dispatch:
    inputs:
      index:
        description: 'Market index to update'
        required: false
        default: 'ALL'
        type: choice
        options:
          - ALL
          - SP500
          - SP400
          - SP600
          - NASDAQ100
          - DOW30
          - COMBINED

env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
            
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Verify PostgreSQL connection
        run: |
          python -c "
          import os
          from sqlalchemy import create_engine, text
          
          db_url = os.environ.get('DATABASE_URL')
          if not db_url:
              print('‚ùå DATABASE_URL not found')
              exit(1)
          
          try:
              engine = create_engine(db_url)
              with engine.connect() as conn:
                  result = conn.execute(text('SELECT 1'))
                  print('‚úÖ PostgreSQL connection successful')
          except Exception as e:
              print(f'‚ùå PostgreSQL connection failed: {e}')
              exit(1)
          "
          
      - name: Update S&P 500 data
        if: github.event.inputs.index == 'SP500' || github.event.inputs.index == 'ALL' || github.event_name == 'schedule'
        run: |
          python -c "
          import sys
          try:
              from market_tracker import run_cli
              print('Starting S&P 500 data update...')
              run_cli(consecutive_days=7, index_key='SP500')
              print('‚úÖ S&P 500 data saved to PostgreSQL!')
          except Exception as e:
              print(f'‚ùå Error updating S&P 500 data: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          "
          
      - name: Update S&P MidCap 400 data
        if: github.event.inputs.index == 'SP400' || github.event.inputs.index == 'ALL' || github.event_name == 'schedule'
        run: |
          python -c "
          import sys
          try:
              from market_tracker import run_cli
              print('Starting S&P MidCap 400 data update...')
              run_cli(consecutive_days=7, index_key='SP400')
              print('‚úÖ S&P MidCap 400 data saved to PostgreSQL!')
          except Exception as e:
              print(f'‚ùå Error updating S&P MidCap 400 data: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          "
          
      - name: Update S&P SmallCap 600 data
        if: github.event.inputs.index == 'SP600' || github.event.inputs.index == 'ALL' || github.event_name == 'schedule'
        run: |
          python -c "
          import sys
          try:
              from market_tracker import run_cli
              print('Starting S&P SmallCap 600 data update...')
              run_cli(consecutive_days=7, index_key='SP600')
              print('‚úÖ S&P SmallCap 600 data saved to PostgreSQL!')
          except Exception as e:
              print(f'‚ùå Error updating S&P SmallCap 600 data: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          "
          
      - name: Update Nasdaq-100 data
        if: github.event.inputs.index == 'NASDAQ100' || github.event.inputs.index == 'ALL' || github.event_name == 'schedule'
        run: |
          python -c "
          import sys
          try:
              from market_tracker import run_cli
              print('Starting Nasdaq-100 data update...')
              run_cli(consecutive_days=7, index_key='NASDAQ100')
              print('‚úÖ Nasdaq-100 data saved to PostgreSQL!')
          except Exception as e:
              print(f'‚ùå Error updating Nasdaq-100 data: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          "
          
      - name: Update Dow Jones 30 data
        if: github.event.inputs.index == 'DOW30' || github.event.inputs.index == 'ALL' || github.event_name == 'schedule'
        run: |
          python -c "
          import sys
          try:
              from market_tracker import run_cli
              print('Starting Dow Jones 30 data update...')
              run_cli(consecutive_days=7, index_key='DOW30')
              print('‚úÖ Dow Jones 30 data saved to PostgreSQL!')
          except Exception as e:
              print(f'‚ùå Error updating Dow Jones 30 data: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          "
          
      - name: Update Combined indices data
        if: github.event.inputs.index == 'COMBINED' || github.event.inputs.index == 'ALL' || github.event_name == 'schedule'
        run: |
          python -c "
          import sys
          try:
              from market_tracker import run_cli
              print('Starting Combined indices data update...')
              run_cli(consecutive_days=7, index_key='COMBINED')
              print('‚úÖ Combined indices data saved to PostgreSQL!')
          except Exception as e:
              print(f'‚ùå Error updating Combined indices data: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          "
          
      - name: Verify database updates
        if: always()
        run: |
          python -c "
          import os
          from sqlalchemy import create_engine, text
          
          db_url = os.environ.get('DATABASE_URL')
          if not db_url:
              print('DATABASE_URL not found')
              exit(0)
          
          try:
              engine = create_engine(db_url)
              
              print('\\n=== Database Statistics ===')
              
              with engine.connect() as conn:
                  # Total stocks
                  result = conn.execute(text('SELECT COUNT(*) FROM stocks'))
                  total = result.scalar()
                  print(f'Total stocks in database: {total:,}')
                  
                  # By index
                  result = conn.execute(text('''
                      SELECT index_name, COUNT(*) as count, MAX(updated_at) as last_update
                      FROM stocks 
                      GROUP BY index_name
                      ORDER BY index_name
                  '''))
                  
                  print('\\nStocks by index:')
                  for row in result:
                      print(f'  ‚Ä¢ {row[0]}: {row[1]:,} stocks (last updated: {row[2]})')
                  
          except Exception as e:
              print(f'Error querying database: {e}')
          "
          
      - name: Workflow Summary
        if: always()
        run: |
          echo "=== Workflow Summary ==="
          echo "Timestamp: $(date)"
          echo "Trigger: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger - Index: ${{ github.event.inputs.index }}"
          else
            echo "Scheduled trigger - All indices updated"
          fi
          echo ""
          echo "‚úÖ Data stored in PostgreSQL (not committed to Git)"
          echo "üìä Streamlit app will load data from database"